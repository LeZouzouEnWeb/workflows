name: üîó Lier le projet a la PR

on:
  workflow_call:
    inputs:
      PR_KEYWORD:
        description: "Mot-cl√© pour lier l issue (Closes, Fixes, Resolves, etc.)"
        required: false
        type: string
        default: "Closes"
      project-url:
        description: "URL du projet GitHub"
        required: true
        type: string
    secrets:
      ADD_TO_PROJECT_PAT:
        description: "PAT avec permissions repository-projects"
        required: true
      CORBIDEV_PROJECT_ID:
        description: "ID du projet CORBIDEV"
        required: false

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  link:
    runs-on: ubuntu-latest

    steps:
      - name: Detect ticket and ensure PR references it
        id: detect
        uses: actions/github-script@v7
        env:
          PR_KEYWORD: ${{ inputs.PR_KEYWORD }}
        with:
          result-encoding: string
          script: |
            const pr = context.payload.pull_request;
            const {owner, repo} = context.repo;

            const title = pr.title || "";
            const branch = pr.head?.ref || "";
            const body   = pr.body || "";

            const patterns = [
              /\[#?(\d+)\]/i,
              /(?:^|\s)#(\d+)(?=\s|$)/,
              /ticket[-_\/]?(\d+)/i
            ];
            let ticket = null;
            for (const rx of patterns) {
              const m = title.match(rx) || branch.match(rx) || body.match(rx);
              if (m) { ticket = parseInt(m[1],10); break; }
            }
            if (!ticket) {
              core.setFailed("Aucun num√©ro de ticket d√©tect√© (titre/branche/body).");
              return JSON.stringify({});
            }

            // V√©rifier que l'issue existe
            await github.rest.issues.get({ owner, repo, issue_number: ticket });

            // R√©cup√©rer les node_id via GraphQL (format global requis)
            const query = `
              query($owner: String!, $repo: String!, $issueNumber: Int!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  issue(number: $issueNumber) {
                    id
                  }
                  pullRequest(number: $prNumber) {
                    id
                  }
                }
              }
            `;

            const result = await github.graphql(query, {
              owner,
              repo,
              issueNumber: ticket,
              prNumber: pr.number
            });

            const issueNodeId = result.repository.issue.id;
            const prNodeId = result.repository.pullRequest.id;

            // Garantir le lien PR -> issue
            const kw = process.env.PR_KEYWORD || "Closes";
            if (!new RegExp(`\\b#${ticket}\\b`).test(body)) {
              const newBody = (body ? body + "\n\n" : "") + `${kw} #${ticket}`;
              await github.rest.pulls.update({ owner, repo, pull_number: pr.number, body: newBody });
              core.info(`PR body mis √† jour avec "${kw} #${ticket}".`);
            }

            // Retourner les node_id GraphQL
            return JSON.stringify({ issue_node_id: issueNodeId, pr_node_id: prNodeId });

      - name: ‚ûï Add ISSUE and PR to CORBIDEV
        uses: actions/github-script@v7
        env:
          PROJECT_URL: ${{ inputs.project-url }}
          PAT: ${{ secrets.ADD_TO_PROJECT_PAT }}
        with:
          github-token: ${{ secrets.ADD_TO_PROJECT_PAT }}
          script: |
            const result = JSON.parse('${{ steps.detect.outputs.result }}');
            const issueNodeId = result.issue_node_id;
            const prNodeId = result.pr_node_id;

            if (!issueNodeId || !prNodeId) {
              core.warning('Node IDs manquants, skip ajout au projet.');
              return;
            }

            // Parser l'URL du projet pour extraire login et num√©ro
            const projectUrl = process.env.PROJECT_URL;
            const urlMatch = projectUrl.match(/github\.com\/(users|orgs)\/([^\/]+)\/projects\/(\d+)/);

            if (!urlMatch) {
              core.setFailed('Format d URL de projet invalide');
              return;
            }

            const [, type, login, projectNumber] = urlMatch;
            const entityType = type === 'users' ? 'user' : 'organization';

            // R√©cup√©rer l'ID du projet via son URL
            const projectQuery = `
              query($login: String!, $number: Int!) {
                ${entityType}(login: $login) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }
            `;

            const projectResult = await github.graphql(projectQuery, {
              login: login,
              number: parseInt(projectNumber, 10)
            });

            const projectId = projectResult[entityType].projectV2.id;
            core.info(`Project ID: ${projectId}`);

            // Ajouter l'issue au projet
            const addIssueMutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {projectId: $projectId, contentId: $contentId}) {
                  item {
                    id
                  }
                }
              }
            `;

            try {
              await github.graphql(addIssueMutation, {
                projectId: projectId,
                contentId: issueNodeId
              });
              core.info(`‚úÖ Issue ajout√©e au projet`);
            } catch (e) {
              core.warning(`Issue d√©j√† dans le projet ou erreur: ${e.message}`);
            }

            // Ajouter la PR au projet
            try {
              await github.graphql(addIssueMutation, {
                projectId: projectId,
                contentId: prNodeId
              });
              core.info(`‚úÖ PR ajout√©e au projet`);
            } catch (e) {
              core.warning(`PR d√©j√† dans le projet ou erreur: ${e.message}`);
            }
