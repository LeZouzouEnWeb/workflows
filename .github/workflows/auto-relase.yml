name: üìà Auto Release

on:
  push:
    tags:
      - "v*.*.*" # Ex: v1.0.0, v2.3.1
  workflow_dispatch:
    inputs:
      version:
        description: "Version √† publier (ex: v1.2.3)"
        required: true
        type: string
      target:
        description: "SHA ou branche √† cibler (par d√©faut: commit courant)"
        required: false
        type: string

permissions:
  contents: write

jobs:
  release:
    name: üîñ Release (main)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Si lanc√© manuellement, on cr√©e (ou pousse) le tag demand√© vers le repo.
      - name: Ensure tag exists (workflow_dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.version }}"
          TARGET="${{ inputs.target }}"
          if [ -z "$TARGET" ]; then
            TARGET="${GITHUB_SHA}"
          fi

          # Si le tag existe d√©j√† c√¥t√© distant, on ne refait rien
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "Tag ${TAG} already exists on remote."
          else
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "${TAG}" -m "Release ${TAG}" "${TARGET}"
            git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
            git push origin "${TAG}"
            echo "Pushed tag ${TAG} at ${TARGET}"
          fi
          echo "TAG_NAME=${TAG}" >> "$GITHUB_ENV"

      # Si d√©clench√© par un push de tag, on r√©cup√®re le nom du tag automatiquement
      - name: Set TAG_NAME from push
        if: ${{ github.event_name == 'push' }}
        run: echo "TAG_NAME=${GITHUB_REF_NAME}" >> "$GITHUB_ENV"

      # (Optionnel) Build/packaging avant release ‚Äî √† adapter √† ton projet
      # - name: Build
      #   run: |
      #     npm ci
      #     npm run build
      #   # Ou Maven/Gradle/Make/etc.

      # Cr√©e la release avec release notes auto
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Release ${{ env.TAG_NAME }}"
          generate_release_notes: true
          # Si ton tag est de type pr√©-release (ex: v2.0.0-rc.1), on coche automatiquement "pre-release"
          prerelease: ${{ contains(env.TAG_NAME, '-') }}
          # Attache automatiquement les artefacts si pr√©sents
          files: |
            dist/**/*
            build/**/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
