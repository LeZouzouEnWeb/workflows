name: üîó Lier les tickets a la PR

on:
  workflow_call:
    inputs: {}
    secrets: {}

jobs:
  link:
    runs-on: ubuntu-latest
    steps:
      - name: Detecter et lier les tickets dans la PR
        uses: actions/github-script@v7
        with:
          script:
            "const pr = context.payload.pull_request;\nconst owner = context.repo.owner;\n\
            const repo = context.repo.repo;\n\n// --- Regex robustes, sans variables\
            \ d'env ni groupes nomm√©s ---\n// A. Formats \"ticket-123\", \"ticket 123\"\
            , \"ticket_123\" (branche & titre)\nconst reTicketInBranch = /(?:^|[\\\\\
            /_-])ticket[-_ ]?(\\d+)(?=$|[^0-9])/ig;\nconst reTicketInText   = /\\bticket[-_\
            \ ]?(\\d+)\\b/ig;\n\n// B. Liens #123, cl√©s PROJ-123, et fermetures \"fix/close/resolve\
            \ #123\"\nconst reHashIssue     = /#(\\d+)\\b/g;\nconst reProjectIssue \
            \ = /\\b[A-Z][A-Z0-9_]+-(\\d+)\\b/g;\nconst reClosingRef    = /(?:close[sd]?|fix(?:es|ed)?|resolve(?:s|d)?)\\\
            s+#(\\d+)/ig;\n\n// Verbe fort d√©tect√© n'importe o√π => \"Fixes #\"\nconst\
            \ strongVerbRe    = /\\b(fix(?:es|ed)?|close(?:s|d)?|resolve(?:s|d)?)\\\
            b/i;\n\nconst branch = pr.head.ref || '';\nconst title  = pr.title || '';\n\
            let body     = pr.body || '';\n\n// R√©cup√©rer tous les messages de commit\
            \ de la PR\nconst commits = await github.paginate(\n  github.rest.pulls.listCommits,\n\
            \  { owner, repo, pull_number: pr.number, per_page: 100 }\n);\nconst commitMessages\
            \ = commits.map(c => c.commit.message).join('\\n');\n\n// Pour debug\nconsole.log(`PR\
            \ #${pr.number} ‚Äî BRANCH=\"${branch}\" TITLE=\"${title}\"`);\nconst haystack\
            \ = [branch, title, body, commitMessages].join('\\n');\n\n// ---- D√©tection\
            \ des num√©ros ----\nconst found = new Set();\n\n// 1) ticket-123 dans le\
            \ NOM DE BRANCHE\nfor (const m of branch.matchAll(reTicketInBranch)) {\n\
            \  const n = Number(m[1]); if (Number.isInteger(n)) found.add(n);\n}\n\n\
            // 2) ticket-123 / ticket 123 / ticket_123 dans TITRE + BODY + COMMITS\n\
            for (const m of title.matchAll(reTicketInText)) {\n  const n = Number(m[1]);\
            \ if (Number.isInteger(n)) found.add(n);\n}\nfor (const m of body.matchAll(reTicketInText))\
            \ {\n  const n = Number(m[1]); if (Number.isInteger(n)) found.add(n);\n\
            }\nfor (const m of commitMessages.matchAll(reTicketInText)) {\n  const n\
            \ = Number(m[1]); if (Number.isInteger(n)) found.add(n);\n}\n\n// 3) #123\
            \ (dans titre/body/commits)\nfor (const m of haystack.matchAll(reHashIssue))\
            \ {\n  const n = Number(m[1]); if (Number.isInteger(n)) found.add(n);\n\
            }\n\n// 4) PROJ-123 (dans titre/body/commits)\nfor (const m of haystack.matchAll(reProjectIssue))\
            \ {\n  const n = Number(m[1]); if (Number.isInteger(n)) found.add(n);\n\
            }\n\n// 5) Fermetures explicites \"fix/close/resolve #123\"\nfor (const\
            \ m of haystack.matchAll(reClosingRef)) {\n  const n = Number(m[1]); if\
            \ (Number.isInteger(n)) found.add(n);\n}\n\nconsole.log('NUM√âROS d√©tect√©s:',\
            \ [...found]);\n\nif (found.size === 0) {\n  core.setFailed(\n    'Cette\
            \ PR n‚Äôest li√©e √† aucun ticket/issue d√©tect√©.\\n' +\n    'Accepte l‚Äôun des\
            \ crit√®res : Closes #123 | titre PROJ-123 | branche ticket-123.'\n  );\n\
            \  return;\n}\n\nconst useFixes = strongVerbRe.test(haystack);\n\n// ----\
            \ √âviter les doublons dans le body de la PR ----\nconst already = new Set();\n\
            const bodyLower = body.toLowerCase();\nfor (const n of found) {\n  if (bodyLower.includes(`#${n}`))\
            \ already.add(n);\n}\n\nconst toAdd = [...found].filter(n => !already.has(n));\n\
            if (toAdd.length === 0) {\n  console.log('Tous les tickets d√©tect√©s sont\
            \ d√©j√† r√©f√©renc√©s dans la PR.');\n  return;\n}\n\nconst prefix = useFixes\
            \ ? 'Fixes' : 'Related to';\nconst lines = toAdd.map(n => `${prefix} #${n}`).join('\\\
            n');\nconst separator = body.trim().length ? '\\n\\n' : '';\nconst newBody\
            \ = `${body}${separator}<!-- auto-linked by workflow -->\\n${lines}\\n`;\n\
            \nawait github.rest.pulls.update({\n  owner, repo,\n  pull_number: pr.number,\n\
            \  body: newBody\n});\n\nconsole.log(`Ajout√© dans la PR: ${lines}`);\n"
permissions:
  contents: read
  pull-requests: write
