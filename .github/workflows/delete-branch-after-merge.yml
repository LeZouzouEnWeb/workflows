name: üóë Supprimer la branche apres fusion

on:
  workflow_call:
    inputs: {}
    secrets: {}

jobs:
  delete_branch:
    name: üóë Supprimer la branche source quand la PR est mergee
    runs-on: ubuntu-latest
    steps:
      - name: Supprimer la branche ou expliquer si ignoree
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script:
            "const pr = context.payload.pull_request;\nconst owner = context.repo.owner;\n\
            const repo  = context.repo.repo;\nconst headRef = pr.head.ref; // source\
            \ branch\nconst baseRef = pr.base.ref; // target branch\nconst defaultBranch\
            \ = context.payload.repository.default_branch;\nconst sameRepo = pr.head.repo.full_name\
            \ === `${owner}/${repo}`;\nconst merged = pr.merged === true;\nconst forbidden\
            \ = (process.env.FORBIDDEN_BRANCHES || \"\")\n  .split(\",\")\n  .map(s\
            \ => s.trim())\n  .filter(Boolean);\n\nfunction comment(body) {\n  return\
            \ github.rest.issues.createComment({\n    owner,\n    repo,\n    issue_number:\
            \ pr.number,\n    body\n  });\n}\n\nlet reason = null;\nif (!merged) {\n\
            \  reason = \"PR not merged.\";\n} else if (!sameRepo) {\n  reason = \"\
            Branch originates from a fork (external repository).\";\n} else if (headRef\
            \ === baseRef) {\n  reason = `Head branch equals base branch (${baseRef}).`;\n\
            } else if (headRef === defaultBranch) {\n  reason = `Head branch is the\
            \ default branch (${defaultBranch}).`;\n} else if (forbidden.includes(headRef))\
            \ {\n  reason = `Head branch '${headRef}' is in the forbidden list: ${forbidden.join(\"\
            , \")}`;\n}\n\nif (reason) {\n  const msg = `\U0001F6C8 Auto-delete skipped:\
            \ ${reason}`;\n  core.notice(msg);\n  await comment(msg);\n  return;\n}\n\
            \ntry {\n  core.info(`Attempting to delete heads/${headRef} on ${owner}/${repo}`);\n\
            \  await github.rest.git.deleteRef({\n    owner,\n    repo,\n    ref: `heads/${headRef}`\n\
            \  });\n  const ok = `‚úÖ Deleted branch heads/${headRef}`;\n  core.notice(ok);\n\
            \  await comment(ok);\n} catch (error) {\n  const msg = `‚ö†Ô∏è Failed to delete\
            \ branch heads/${headRef}: ${error?.message || error}`;\n  core.warning(msg);\n\
            \  await comment(msg);\n  throw error;\n}\n"
permissions:
  contents: write
  pull-requests: write
