name: Pre-Release (develop & homol)

on:
  push:
    tags:
      - "v*.*.*-*" # ex: v1.4.0-rc.1, v1.4.0-beta.2, v1.4.0-dev.3
  workflow_dispatch:
    inputs:
      version:
        description: "Tag pr√©-release (ex: v1.4.0-rc.1 ou v1.4.0-beta.1)"
        required: true
        type: string
      target_branch:
        description: "Branche cible (develop ou homol)"
        required: true
        type: choice
        options: [develop, homol]

permissions:
  contents: write

jobs:
  prerelease:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag exists (workflow_dispatch)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ inputs.version }}"
          BR="${{ inputs.target_branch }}"
          echo "Creating tag ${TAG} on ${BR}‚Ä¶"

          git fetch origin "${BR}:${BR}" --update-head-ok
          git checkout "${BR}"

          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}$"; then
            echo "Tag ${TAG} already exists on remote."
          else
            git config user.name  "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git tag -a "${TAG}" -m "Pre-release ${TAG} on ${BR}"
            git push origin "${TAG}"
            echo "Pushed ${TAG} on ${BR}"
          fi

      - name: Resolve tagged commit & fetch branches
        run: |
          git fetch --all --prune --tags
          echo "TAG_NAME=${GITHUB_REF_NAME:-${{ inputs.version }}}" >> "$GITHUB_ENV"
          TAG="${GITHUB_REF_NAME:-${{ inputs.version }}}"
          COMMIT_SHA="$(git rev-list -n 1 "$TAG")"
          echo "COMMIT_SHA=${COMMIT_SHA}" >> "$GITHUB_ENV"

          ENVIRON=""
          if git merge-base --is-ancestor "$COMMIT_SHA" "origin/homol"; then
            ENVIRON="homol"
          elif git merge-base --is-ancestor "$COMMIT_SHA" "origin/develop"; then
            ENVIRON="develop"
          else
            echo "::warning::Le commit tagg√© n'est contenu ni dans origin/homol ni dans origin/develop."
            ENVIRON="unknown"
          fi
          echo "ENVIRON=${ENVIRON}" >> "$GITHUB_ENV"

      - name: Hint suffix vs branche (non bloquant)
        run: |
          case "${ENVIRON}" in
            homol)
              echo "üí° Conseill√© sur homol: suffixes -rc.N (ex: v1.4.0-rc.1)"
              ;;
            develop)
              echo "üí° Conseill√© sur develop: suffixes -beta.N ou -dev.N (ex: v1.4.0-beta.1)"
              ;;
            *)
              echo "‚ö†Ô∏è  Tag non rattach√© √† develop/homol. La pr√©-release sera quand m√™me cr√©√©e."
              ;;
          esac

      - name: Create GitHub Pre-Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "Pre-release ${{ env.TAG_NAME }} (${{ env.ENVIRON }})"
          body: |
            üß™ Pr√©-release pour **${{ env.ENVIRON }}**
            Tag: `${{ env.TAG_NAME }}`
            Commit: ${{ env.COMMIT_SHA }}
            Release notes auto ci-dessous üëá
          generate_release_notes: true
          prerelease: true
          files: |
            dist/**/*
            build/**/*
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
