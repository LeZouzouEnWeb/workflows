# ğŸ“ Template de workflow rÃ©utilisable

Template complet et commentÃ© pour crÃ©er un nouveau workflow rÃ©utilisable.

```yaml
name: ğŸ“¦ Mon workflow rÃ©utilisable

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DÃ‰CLENCHEURS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  workflow_call:
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # INPUTS : ParamÃ¨tres d'entrÃ©e
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    inputs:
      environment:
        description: 'Environnement cible (dev/homol/prod)'
        type: string
        required: true

      version:
        description: 'Version Ã  dÃ©ployer (ex: 1.2.3)'
        type: string
        required: false
        default: 'latest'

      dry_run:
        description: 'Mode simulation (pas de dÃ©ploiement rÃ©el)'
        type: boolean
        required: false
        default: false

      timeout:
        description: 'Timeout en secondes'
        type: number
        required: false
        default: 300

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # SECRETS : Valeurs sensibles
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    secrets:
      DEPLOY_KEY:
        description: 'ClÃ© de dÃ©ploiement SSH'
        required: true

      API_TOKEN:
        description: 'Token d\'API pour notifications'
        required: false

      DATABASE_URL:
        description: 'URL de connexion base de donnÃ©es'
        required: true

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # OUTPUTS : Valeurs de retour
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    outputs:
      deployment_url:
        description: 'URL du dÃ©ploiement effectuÃ©'
        value: ${{ jobs.deploy.outputs.url }}

      deployment_time:
        description: 'Timestamp du dÃ©ploiement'
        value: ${{ jobs.deploy.outputs.timestamp }}

      status:
        description: 'Statut du dÃ©ploiement (success/failure)'
        value: ${{ jobs.deploy.outputs.status }}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# PERMISSIONS : Permissions GITHUB_TOKEN
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
permissions:
  contents: read        # Lecture du code
  deployments: write    # CrÃ©er des dÃ©ploiements
  statuses: write       # CrÃ©er des statuts de commit

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# CONCURRENCY : ContrÃ´le d'exÃ©cution
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
concurrency:
  group: deploy-${{ inputs.environment }}
  cancel-in-progress: false  # Ne jamais annuler un dÃ©ploiement

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# JOBS
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 1 : Validation
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  validate:
    name: ğŸ” Validation des paramÃ¨tres
    runs-on: ubuntu-latest

    steps:
      - name: Valider l'environnement
        run: |
          ENV="${{ inputs.environment }}"
          case "$ENV" in
            dev|homol|prod)
              echo "âœ… Environnement valide: $ENV"
              ;;
            *)
              echo "::error title=Environnement invalide::Attendu: dev/homol/prod, reÃ§u: $ENV"
              exit 1
              ;;
          esac

      - name: Valider les secrets
        run: |
          missing=0

          if [ -z "${{ secrets.DEPLOY_KEY }}" ]; then
            echo "::error title=Secret manquant::DEPLOY_KEY n'est pas dÃ©fini"
            missing=1
          fi

          if [ -z "${{ secrets.DATABASE_URL }}" ]; then
            echo "::error title=Secret manquant::DATABASE_URL n'est pas dÃ©fini"
            missing=1
          fi

          [ "$missing" -eq 0 ] || exit 1

      - name: RÃ©sumÃ© de validation
        run: |
          echo "### âœ… Validation rÃ©ussie" >> $GITHUB_STEP_SUMMARY
          echo "- **Environnement** : \`${{ inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Version** : \`${{ inputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Mode dry-run** : \`${{ inputs.dry_run }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Timeout** : \`${{ inputs.timeout }}s\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 2 : DÃ©ploiement
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  deploy:
    name: ğŸš€ DÃ©ploiement vers ${{ inputs.environment }}
    needs: validate
    runs-on: ubuntu-latest
    timeout-minutes: ${{ fromJSON(inputs.timeout) / 60 }}

    # DÃ©finir les outputs du job
    outputs:
      url: ${{ steps.deploy.outputs.url }}
      timestamp: ${{ steps.deploy.outputs.timestamp }}
      status: ${{ steps.deploy.outputs.status }}

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.DEPLOY_KEY }}

      - name: PrÃ©parer le dÃ©ploiement
        id: prepare
        run: |
          echo "PrÃ©paration du dÃ©ploiement..."

          # Construire l'URL de dÃ©ploiement
          URL="https://${{ inputs.environment }}.example.com"
          echo "deployment_url=$URL" >> $GITHUB_OUTPUT

          # Mode dry-run ?
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "::notice::Mode dry-run activÃ© - pas de dÃ©ploiement rÃ©el"
          fi

      - name: DÃ©ployer
        id: deploy
        run: |
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "ğŸ” Mode simulation - pas de dÃ©ploiement rÃ©el"
            STATUS="simulated"
          else
            echo "ğŸš€ DÃ©ploiement rÃ©el vers ${{ inputs.environment }}"

            # Votre logique de dÃ©ploiement ici
            # rsync, scp, kubectl, etc.

            STATUS="success"
          fi

          # Timestamp ISO 8601
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          # DÃ©finir les outputs
          echo "url=${{ steps.prepare.outputs.deployment_url }}" >> $GITHUB_OUTPUT
          echo "timestamp=$TIMESTAMP" >> $GITHUB_OUTPUT
          echo "status=$STATUS" >> $GITHUB_OUTPUT

      - name: RÃ©sumÃ© du dÃ©ploiement
        run: |
          echo "### ğŸš€ DÃ©ploiement terminÃ©" >> $GITHUB_STEP_SUMMARY
          echo "- **URL** : [${{ steps.deploy.outputs.url }}](${{ steps.deploy.outputs.url }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp** : \`${{ steps.deploy.outputs.timestamp }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Statut** : \`${{ steps.deploy.outputs.status }}\`" >> $GITHUB_STEP_SUMMARY

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # JOB 3 : Notification (optionnel)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  notify:
    name: ğŸ“¢ Notification
    needs: deploy
    if: ${{ always() && secrets.API_TOKEN != '' }}
    runs-on: ubuntu-latest

    steps:
      - name: Notifier le succÃ¨s
        if: ${{ needs.deploy.result == 'success' }}
        run: |
          echo "âœ… Notification de succÃ¨s"
          # curl -X POST votre_api_de_notification

      - name: Notifier l'Ã©chec
        if: ${{ needs.deploy.result == 'failure' }}
        run: |
          echo "âŒ Notification d'Ã©chec"
          # curl -X POST votre_api_de_notification
```

## Utilisation de ce template

### Workflow consommateur

```yaml
name: DÃ©ploiement Dev

on:
  push:
    branches: [develop]

permissions:
  contents: read
  deployments: write
  statuses: write

jobs:
  deploy:
    uses: owner/repo/.github/workflows/template.yml@v1
    with:
      environment: dev
      version: '1.2.3'
      dry_run: false
      timeout: 600
    secrets:
      DEPLOY_KEY: ${{ secrets.DEV_DEPLOY_KEY }}
      API_TOKEN: ${{ secrets.SLACK_WEBHOOK }}
      DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
```

## Points clÃ©s

### âœ… Ce template inclut

- **Validation complÃ¨te** des inputs et secrets
- **Outputs** pour chaÃ®ner avec d'autres workflows
- **Concurrency** pour Ã©viter les conflits
- **Permissions** explicites et minimales
- **Step summaries** pour la visibilitÃ©
- **Gestion des erreurs** avec messages clairs
- **Mode dry-run** pour les tests
- **Timeouts** configurables
- **Notifications** optionnelles

### ğŸ”§ Ã€ personnaliser

1. Remplacer la logique de dÃ©ploiement dans le job `deploy`
2. Adapter les validations selon vos besoins
3. Ajouter/supprimer des inputs/secrets selon le contexte
4. Personnaliser les notifications
5. Ajuster les permissions selon les actions utilisÃ©es

### ğŸ“š Ressources

- [Fondamentaux - workflow_call](../fondamentaux/01-workflow-call.md)
- [Fondamentaux - Inputs & Outputs](../fondamentaux/02-inputs-outputs.md)
- [Fondamentaux - Secrets](../fondamentaux/03-secrets.md)
