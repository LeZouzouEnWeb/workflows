name: üîÑ Mettre a jour le titre de la PR
# Structure requise dans update-pr-title.yml
on:
  workflow_call:
    inputs:
      example-input:
        required: false
        type: string
    secrets:
      EXAMPLE_SECRET:
        required: false
        description: 'Un secret exemple'
        
jobs:
  update-title:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
    - name: Mettre a jour le titre depuis la branche
      uses: actions/github-script@v7
      with:
        script: "const pr = context.payload.pull_request;\nif (!pr) return;\n\nconst\
          \ branch = pr.head?.ref || \"\";\nconst origTitle = pr.title || \"\";\n\n\
          // 1Ô∏è‚É£ Nettoyage de base (hyphens, underscores, slashes ‚Üí espaces)\nconst\
          \ cleanBranch = branch\n  .replace(/[-_/]+/g, \" \")\n  .replace(/\\s+/g,\
          \ \" \")\n  .trim();\n\n// 2Ô∏è‚É£ Si le titre est d√©j√† normalis√©, on sort\n\
          if (/^\\s*\\[#\\d+\\]\\s+/i.test(origTitle)) {\n  core.info(\"Titre d√©j√†\
          \ normalis√©, aucun changement.\");\n  return;\n}\n\n// 3Ô∏è‚É£ Recherche du\
          \ num√©ro de ticket\nconst ticketMatch = branch.match(/ticket[-_\\s]?(\\\
          d{1,8})\\b/i);\nconst num = ticketMatch ? ticketMatch[1] : null;\n\nlet\
          \ prefix = \"\";\nlet label = cleanBranch;\n\nif (num) {\n  const cleanTicketRe\
          \ = /\\bticket\\s*\\d{1,8}\\b/i;\n  const cleanTicketMatch = cleanTicketRe.exec(cleanBranch);\n\
          \  if (cleanTicketMatch) {\n    const before = cleanBranch.slice(0, cleanTicketMatch.index).trim();\n\
          \    const after = cleanBranch.slice(cleanTicketMatch.index + cleanTicketMatch[0].length).trim();\n\
          \n    if (after) {\n      prefix = before;\n      label = after;\n    }\
          \ else if (before) {\n      label = before;\n    }\n  } else {\n    label\
          \ = cleanBranch.replace(cleanTicketRe, \"\").trim() || cleanBranch;\n  }\n\
          }\n\n// 4Ô∏è‚É£ D√©tection d'un pr√©fixe standard si non trouv√©\nif (!prefix)\
          \ {\n  const prefixMatch = label.match(/^(feature|fix|hotfix|bugfix|release|chore|task|refactor)\\\
          b/i);\n  if (prefixMatch) {\n    prefix = prefixMatch[1].toLowerCase();\n\
          \    label = label.replace(new RegExp(\"^\" + prefixMatch[0] + \"\\\\b\\\
          \\s*\"), \"\").trim();\n  }\n}\n\n// 5Ô∏è‚É£ Nettoyage final des segments\n\
          prefix = prefix.replace(/\\s+/g, \" \").trim();\nlabel = label.replace(/\\\
          s+/g, \" \").trim();\n\nif (!label) {\n  label = cleanBranch || branch;\n\
          }\n\n// 6Ô∏è‚É£ Construction du titre\nconst parts = [];\nif (num) parts.push(`[#${num}]`);\n\
          if (prefix) parts.push(prefix);\nif (label) parts.push(label);\n\nconst\
          \ newTitle = parts.join(\" - \").trim();\n\n// 7Ô∏è‚É£ Mise √† jour du titre\
          \ si diff√©rent\nif (newTitle && newTitle !== origTitle) {\n  await github.rest.pulls.update({\n\
          \    owner: context.repo.owner,\n    repo: context.repo.repo,\n    pull_number:\
          \ pr.number,\n    title: newTitle\n  });\n  core.info(`Titre mis √† jour:\
          \ \"${origTitle}\" ‚Üí \"${newTitle}\"`);\n} else {\n  core.info(\"Aucun changement\
          \ appliqu√© au titre.\");\n}\n"
permissions:
  contents: read
  pull-requests: write
