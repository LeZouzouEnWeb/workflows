name: üî≥ Verification serveur Homol

on:
  workflow_call:
    secrets:
      SFTP_HOST:
        required: true
        description: 'H√¥te SFTP du serveur distant'
      SFTP_USER:
        required: true
        description: 'Utilisateur SFTP pour la connexion'
      SSH_PRIVATE_KEY:
        required: true
        description: "Cl√© priv√©e SSH pour l'authentification"
      REMOTE_CHEMIN:
        required: true
        description: 'Chemin de base sur le serveur distant'
    inputs:
      SFTP_PORT:
        required: false
        type: string
        default: '22'
        description: 'Port SFTP (g√©n√©ralement 22)'
      ADRESSE_GLOBAL:
        required: true
        type: string
        description: 'Var repo: pr√©fixe global (ex: /var/www)'
      ADRESSE_LOCAL:
        required: true
        type: string
        description: 'Var repo: sous-dossier projet/app'
      remote_env:
        required: true
        type: string
        description: 'ENV: dev | homol | prod'
      PATH_ORDER:
        required: false
        type: string
        default: 'local-env'
        description: "Ordre des segments finaux: 'local-env' ou 'env-local'"

permissions:
  contents: read

jobs:
  dev-check:
    name:  üî≥ Verification connexion & dossier serveur homol
    runs-on: ubuntu-latest

    steps:
      - name: Validate inputs
        shell: bash
        run: |
          : "Validate repo vars via inputs"
          test -n "${{ inputs.ADRESSE_GLOBAL }}" || { echo "::error::ADRESSE_GLOBAL manquant (var repo)"; exit 1; }
          test -n "${{ inputs.ADRESSE_LOCAL }}"  || { echo "::error::ADRESSE_LOCAL manquant (var repo)"; exit 1; }
          case "${{ inputs.remote_env }}" in dev|homol|prod) ;; *) echo "::error::remote_env invalide (dev|homol|prod)"; exit 1;; esac
          case "${{ inputs.PATH_ORDER }}" in local-env|env-local) ;; *) echo "::error::PATH_ORDER invalide (local-env|env-local)"; exit 1;; esac

      - name: Verifier les variables requises
        shell: bash
        env:
          REMOTE_CHEMIN: ${{ secrets.REMOTE_CHEMIN }}
          ADRESSE_GLOBAL: ${{ inputs.ADRESSE_GLOBAL }}
          ADRESSE_LOCAL: ${{ inputs.ADRESSE_LOCAL }}
        run: |
          miss=0
          for v in REMOTE_CHEMIN ADRESSE_GLOBAL ADRESSE_LOCAL; do
            if [ -z "${!v}" ]; then
              echo "::error title=Variable manquante::$v n'est pas d√©fini."
              miss=1
            else
              echo "::notice title=Variable::$v=${!v}"
            fi
          done
          [ "$miss" -eq 0 ] || exit 1

      - name: Construire le chemin cible
        id: path
        shell: bash
        env:
          REMOTE_CHEMIN: ${{ secrets.REMOTE_CHEMIN }}
          ADRESSE_GLOBAL: ${{ inputs.ADRESSE_GLOBAL }}
          ADRESSE_LOCAL: ${{ inputs.ADRESSE_LOCAL }}
          REMOTE_ENV: ${{ inputs.remote_env }}
          PATH_ORDER: ${{ inputs.PATH_ORDER }}
        run: |
          if [ "$PATH_ORDER" = "env-local" ]; then
            PAIR="${REMOTE_ENV}/${ADRESSE_LOCAL#/}"
          else
            PAIR="${ADRESSE_LOCAL#/}/${REMOTE_ENV}"
          fi
          REMOTE_PATH="${REMOTE_CHEMIN%/}/${ADRESSE_GLOBAL%/}/${PAIR}"
          echo "REMOTE_PATH=$REMOTE_PATH"
          echo "REMOTE_PATH=$REMOTE_PATH" >> "$GITHUB_OUTPUT"
          echo "::notice title=PATH_ORDER::$PATH_ORDER"

      - name: Configurer SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Verifier connexion SSH
        shell: bash
        run: |
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "echo 'Connexion SSH OK'"

      - name: Verifier/Creer le dossier distant
        shell: bash
        run: |
          REMOTE_PATH="${{ steps.path.outputs.REMOTE_PATH }}"
          echo "V√©rification du dossier : $REMOTE_PATH"
          ssh -o BatchMode=yes -o StrictHostKeyChecking=no ${{ secrets.SFTP_USER }}@${{ secrets.SFTP_HOST }} "\
            if [ -d \"$REMOTE_PATH\" ]; then \
              echo '‚úÖ Dossier d√©j√† pr√©sent : $REMOTE_PATH'; \
            else \
              echo '‚ö†Ô∏è Dossier absent, cr√©ation en cours : $REMOTE_PATH'; \
              mkdir -p \"$REMOTE_PATH\" && echo '‚úÖ Dossier cr√©√©.'; \
            fi"
